easyblock = 'PackedBinary'

name = 'MuJoCo'
version = '3.1.4'

homepage = 'https://mujoco.org/'
description = """MuJoCo stands for Multi-Joint dynamics with Contact. It is a general purpose
physics engine that aims to facilitate research and development in robotics,
biomechanics, graphics and animation, machine learning, and other areas which
demand fast and accurate simulation of articulated structures interacting with
their environment."""

toolchain = {'name': 'foss', 'version': '2023a'}

source_urls = ['https://github.com/deepmind/mujoco/releases/download/%(version)s']
sources = ['%(namelower)s-%(version)s-linux-%(arch)s.tar.gz']
checksums = ['3bb373e081daaf6bf179d7f83dd8fa39e491a6daa4250a1b7ac42850309cb313']

builddependencies = [
    ('binutils', '2.40'),
    ('CMake', '3.26.3'),  # for Python Bindings
    ('Eigen', '3.4.0'),   # for Python Bindings
    ('pybind11', '2.11.1'),  # for Python Bindings
]

# MuJoCo bundles 3 variants of glew using non-standard sonames:
# - libglew with GLX
# - libglewegl with EGL
# - libglewosmesa with OSMESA
# - Software depending on MuJoCo expect these non-standard sonames, so they should not be removed
# - libglew and libglewegl seem to work with Mesa and X11 for toolchain GCCcore/11.2.0
# - libglewosmesa has to be replaced as it links to an old libOSMesa

dependencies = [
    ('glew', '2.2.0', '-osmesa'),
    ('Python', '3.11.3'),  # for Python Bindings
    ('SciPy-bundle', '2023.07'),  # for Python Bindings
    ('Abseil', '20230125.3'),  # for Python Bindings
    ('GLFW', '3.4'),  # for Python Bindings
    ('PyOpenGL', '3.1.7'),  # for Python Bindings
]

# MuJoCo Python Bindings
exts_defaultclass = 'PythonPackage'

exts_default_options = {
    'source_urls': [PYPI_SOURCE],
    'download_dep_fail': True,
    'use_pip': True,
}

exts_list = [
    ('absl-py', '2.1.0', {
        'modulename': 'absl',
        'checksums': ['7820790efbb316739cde8b4e19357243fc3608a152024288513dd968d7d959ff'],
    }),
    ('glfw', '2.7.0', {
        'checksums': ['0e209ad38fa8c5be67ca590d7b17533d95ad1eb57d0a3f07b98131db69b79000'],
    }),
    ('etils', '1.8.0', {
        'checksums': ['fb478f57fec202e260e54c9192b317692fd63db2d11d993e70bcdffa29cccd58'],
    }),
    ('mujoco', version, {
        'patches': ['python-mujoco-3.1.4_use_eb_deps.patch'],
        'preinstallopts': 'MUJOCO_PATH="$EBROOTMUJOCO" MUJOCO_PLUGIN_PATH="$EBROOTMUJOCO/mujoco_plugin"',
        'checksums': [
            {'mujoco-3.1.4.tar.gz': '19d78bd7332b8bf02b8d7ca35d381a9f8f1654f4c70c0d7f499c6d4d807c4059'},
            {'python-mujoco-3.1.4_use_eb_deps.patch':
             '2160f00996011ff31faaf566d1cb0c0ae4fe49b3c36c29e860b34a61fa732b55'},
        ],
    }),
]

modextrapaths = {'PYTHONPATH': 'lib/python%(pyshortver)s/site-packages'}

postinstallcmds = [
    # replace bundled libglewosmesa.so with glew libs from EB
    "ln -sf $EBROOTGLEW/lib64/libGLEW.so %(installdir)s/lib/libglewosmesa.so",
]

sanity_check_paths = {
    'files': ['bin/basic', 'bin/record', 'bin/simulate',
              'lib/libmujoco.%s' % SHLIB_EXT],
    'dirs': ['include', 'model', 'sample', 'bin/mujoco_plugin'],
}

sanity_check_commands = ['basic', 'record', 'testspeed', 'compile']

moduleclass = 'phys'
