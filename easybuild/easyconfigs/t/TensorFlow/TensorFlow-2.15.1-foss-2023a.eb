easyblock = 'PythonBundle'

name = 'TensorFlow'
version = '2.15.1'

homepage = 'https://www.tensorflow.org/'
description = "An open-source software library for Machine Intelligence"

toolchain = {'name': 'foss', 'version': '2023a'}
toolchainopts = {'pic': True}

use_pip = True
sanity_pip_check = True

builddependencies = [
    ('Bazel', '6.1.0'),
    ('git', '2.41.0', '-nodocs'),
    ('pybind11', '2.11.1'),
    ('UnZip', '6.0'),
    ('poetry', '1.5.1'),
    # Compiling with system protobuf don't seem to work, see:
    # https://github.com/tensorflow/tensorflow/issues/61593
    # In addition there are more rules in third_python that
    # do not have corresponding ones in systemlib/protobuf.BUILD
    # ('protobuf', '24.0'),
]

dependencies = [
    ('Python', '3.11.3'),
    ('h5py', '3.9.0'),
    ('cURL', '8.0.1'),
    ('dill', '0.3.7'),
    ('double-conversion', '3.3.0'),
    ('flatbuffers', '23.5.26'),
    ('flatbuffers-python', '23.5.26'),
    ('giflib', '5.2.1'),
    ('hwloc', '2.9.1'),
    ('ICU', '73.2'),
    ('JsonCpp', '1.9.5'),
    ('libjpeg-turbo', '2.1.5.1'),
    ('NASM', '2.16.01'),
    ('nsync', '1.26.0'),
    ('SQLite', '3.42.0'),
    ('patchelf', '0.18.0'),
    ('protobuf-python', '4.24.0'),
    ('libpng', '1.6.39'),
    ('snappy', '1.1.10'),
    ('zlib', '1.2.13'),
    # for grpcio only (Abseil excluded for tensorflow)
    ('OpenSSL', '1.1', '', SYSTEM),
    ('RE2', '2023-08-01'),
    ('Abseil', '20230125.3'),
]

exts_list = [
    ('wrapt', '1.14.1', {
        'checksums': ['380a85cf89e0e69b7cfbe2ea9f765f004ff419f34194018a6827ac0e3edfed4d'],
    }),
    ('typing_extensions', '4.10.0', {
        'checksums': ['b0abd7c89e8fb96f98db18d86106ff1d90ab692004eb746cf6eda2682f91b3cb'],
    }),
    ('termcolor', '2.3.0', {
        'checksums': ['b5b08f68937f138fe92f6c089b99f1e2da0ae56c52b78bf7075fd95420fd9a5a'],
    }),
    ('MarkupSafe', '2.1.5', {
        'checksums': ['d283d37a890ba4c1ae73ffadf8046435c76e7bc2247bbb63c00bd1a709c6544b'],
    }),
    ('Werkzeug', '2.2.2', {
        'checksums': ['7ea2d48322cc7c0f8b3a215ed73eabd7b5d75d0b50e31ab006286ccff9e00b8f'],
    }),
    ('six', '1.16.0', {
        'checksums': ['1e61c37477a1626458e36f7b1d82aa5c9b094fa4802892072e49de9c60c4c926'],
    }),
    ('urllib3', '2.2.1', {
        'checksums': ['d0570876c61ab9e520d776c38acbbb5b05a776d3f9ff98a5c8fd5162a444cf19'],
    }),
    ('idna', '3.6', {
        'checksums': ['9ecdbbd083b06798ae1e86adcbfe8ab1479cf864e4ee30fe4e46a003d12491ca'],
    }),
    ('charset-normalizer', '3.3.2', {
        'checksums': ['f30c3cb33b24454a82faecaf01b19c18562b1e89558fb6c56de4d9118a032fd5'],
    }),
    ('certifi', '2024.2.2', {
        'checksums': ['0569859f95fc761b18b45ef421b1290a0f65f147e92a1e5eb3e635f9a5e4e66f'],
    }),
    ('requests', '2.31.0', {
        'checksums': ['942c5a758f98d790eaed1a29cb6eefc7ffb0d1cf7af05c3d2791656dbd6ad1e1'],
    }),
    ('Markdown', '3.5.2', {
        'checksums': ['e1ac7b3dc550ee80e602e71c1d168002f062e49f1b11e26a36264dafd4df2ef8'],
    }),
    ('oauthlib', '3.2.2', {
        'checksums': ['9859c40929662bec5d64f34d01c99e093149682a3f38915dc0655d5a633dd918'],
    }),
    ('requests-oauthlib', '1.3.1', {
        'checksums': ['75beac4a47881eeb94d5ea5d6ad31ef88856affe2332b9aafb52c6452ccf0d7a'],
    }),
    ('pyasn1-modules', '0.3.0', {
        'source_tmpl': 'pyasn1_modules-%(version)s.tar.gz',
        'checksums': ['5bd01446b736eb9d31512a30d46c1ac3395d676c6f3cafa4c03eb54b9925631c'],
    }),
    ('rsa', '4.9', {
        'checksums': ['e38464a49c6c85d7f1351b0126661487a7e0a14a50f1675ec50eb34d4f20ef21'],
    }),
    ('cachetools', '5.3.3', {
        'checksums': ['ba29e2dfa0b8b556606f097407ed1aa62080ee108ab0dc5ec9d6a723a007d105'],
    }),
    ('gast', '0.5.4', {
        'checksums': ['9c270fe5f4b130969b54174de7db4e764b09b4f7f67ccfc32480e29f78348d97'],
    }),
    ('flatbuffers', '23.5.26', {
        'checksums': ['9ea1144cac05ce5d86e2859f431c6cd5e66cd9c78c558317c7955fb8d4c78d89'],
    }),
    ('astunparse', '1.6.3', {
        'checksums': ['5ad93a8456f0d084c3456d059fd9a92cce667963232cbf763eac3bc5b7940872'],
    }),
    ('tblib', '3.0.0', {
        'checksums': ['93622790a0a29e04f0346458face1e144dc4d32f493714c6c3dff82a4adb77e6'],
    }),
    ('astor', '0.8.1', {
        'checksums': ['6a6effda93f4e1ce9f618779b2dd1d9d84f1e32812c23a29b3fff6fd7f63fa5e'],
    }),
    ('google-auth-oauthlib', '1.2.0', {
        'checksums': ['292d2d3783349f2b0734a0a0207b1e1e322ac193c2c09d8f7c613fb7cc501ea8'],
    }),
    ('google-pasta', '0.2.0', {
        'modulename': 'pasta',
        'checksums': ['c9f2c8dfc8f96d0d5808299920721be30c9eec37f2389f28904f454565c8a16e'],
    }),
    ('absl-py', '1.4.0', {
        'modulename': 'absl',
        'checksums': ['d2c244d01048ba476e7c080bd2c6df5e141d211de80223460d5b3b8a2a58433d'],
    }),
    ('google-auth', '2.28.1', {
        'modulename': 'google.auth',
        'checksums': ['34fc3046c257cedcf1622fc4b31fc2be7923d9b4d44973d481125ecc50d83885'],
    }),
    ('ml-dtypes', '0.3.1', {
        'source_tmpl': (
            'ml_dtypes-%(version)s-'
            'cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl'
        ),
        'checksums': ['42a8980afd8b7c8e270e8b5c260237286b5b26acd276fcb758d13cd7cb567e99'],
    }),
    ('tensorboard-data-server', '0.7.2', {
        'source_tmpl': 'tensorboard_data_server-%(version)s-py3-none-any.whl',
        'checksums': ['7e0610d205889588983836ec05dc098e80f97b7e7bbff7e994ebb78f578d0ddb'],
    }),
    ('tensorflow-estimator', '2.15.0', {
        'source_tmpl': 'tensorflow_estimator-%(version)s-py2.py3-none-any.whl',
        'checksums': ['aedf21eec7fb2dc91150fc91a1ce12bc44dbb72278a08b58e79ff87c9e28f153'],
    }),
    ('tensorboard', '2.15.2', {
        'source_tmpl': '%(name)s-%(version)s-py3-none-any.whl',
        'checksums': ['a6f6443728064d962caea6d34653e220e34ef8df764cb06a8212c17e1a8f0622'],
    }),
    ('keras', '2.15.0', {
        'source_tmpl': '%(name)s-%(version)s-py3-none-any.whl',
        'checksums': ['2dcc6d2e30cf9c951064b63c1f4c404b966c59caf09e01f3549138ec8ee0dd1f'],
    }),
    ('grpcio', '1.60.0', {
        'modulename': 'grpc',
        'preinstallopts': (
            "export GRPC_PYTHON_BUILD_EXT_COMPILER_JOBS=%(parallel)s && "
            # Required to avoid building with non-default C++ standard but keep other flags,
            # see https://github.com/grpc/grpc/issues/34256
            'export GRPC_PYTHON_CFLAGS="-fvisibility=hidden -fno-wrapv -fno-exceptions" &&'
            "GRPC_PYTHON_BUILD_SYSTEM_OPENSSL=True "
            "GRPC_PYTHON_BUILD_SYSTEM_ZLIB=True "
            "GRPC_PYTHON_BUILD_SYSTEM_RE2=True "
            "GRPC_PYTHON_BUILD_SYSTEM_ABSL=True "
        ),
        'patches': ['grpcio-1.16.0_use-ebroot.patch'],
        'checksums': [
            {'grpcio-1.60.0.tar.gz':
             '2199165a1affb666aa24adf0c97436686d0a61bc5fc113c037701fb7c7fceb96'},
            {'grpcio-1.16.0_use-ebroot.patch':
             '5faf822cd817b723ae9361e43656d0ecc7b3333a166bbab2df80b43ae588e510'},
        ],
    }),
    ('opt-einsum', '3.3.0', {
        'source_tmpl': 'opt_einsum-%(version)s-py3-none-any.whl',
        'checksums': ['2455e59e3947d3c275477df7f5205b30635e266fe6dc300e3d9f9646bfcea147'],
    }),
    (name, version, {
        'patches': [
            'TensorFlow-2.13.0_add-missing-system-protobuf-targets.patch',
            'TensorFlow-2.15.1_remove-libclang-dep.patch',
            'TensorFlow-2.15.1_remove-io-gcs-filesystem-dep.patch',
            'TensorFlow-2.15.1_add-default-shell-env.patch',
            'TensorFlow-2.15.1_fix-flatbuffer-license.patch',
            'TensorFlow-2.15.1_fix-pybind11-build.patch',
        ],
        'prebuildopts': (
            'export TF_PYTHON_VERSION=3.11 && '
            'export TF_SYSTEM_LIBS=$(python -c "'
            "print(','.join([l for l in '$TF_SYSTEM_LIBS'.split(',') "
            "      if l not in ['opt_einsum_archive', 'com_google_absl']]))"
            '") && '
        ),
        'preconfigopts': (
            'export TF_NEED_CLANG=no && '
            'export TF_SYSTEM_LIBS=$(python -c "'
            "print(','.join([l for l in '$TF_SYSTEM_LIBS'.split(',') "
            "      if l not in ['opt_einsum_archive', 'com_google_absl']]))"
            '") && '
        ),
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/tensorflow/tensorflow/archive/'],
        'test_script': 'TensorFlow-2.x_mnist-test.py',
        'test_tag_filters_cpu': (
            '-gpu,-tpu,-no_cuda_on_cpu_tap,'
            '-no_pip,-no_oss,-oss_serial,-benchmark-test,-v1only'
        ),
        'test_tag_filters_gpu': (
            'gpu,-no_gpu,-nogpu,-gpu_cupti,-no_cuda11,'
            '-no_pip,-no_oss,-oss_serial,-benchmark-test,-v1only'
        ),
        'test_targets': [
            '//tensorflow/core/...',
            '-//tensorflow/core:example_java_proto',
            '-//tensorflow/core/example:example_protos_closure',
            '//tensorflow/cc/...',
            '//tensorflow/c/...',
            '//tensorflow/python/...',
            '-//tensorflow/c/eager:c_api_test_gpu',
            '-//tensorflow/c/eager:c_api_distributed_test',
            '-//tensorflow/c/eager:c_api_distributed_test_gpu',
            '-//tensorflow/c/eager:c_api_cluster_test_gpu',
            '-//tensorflow/c/eager:c_api_remote_function_test_gpu',
            '-//tensorflow/c/eager:c_api_remote_test_gpu',
            '-//tensorflow/core/common_runtime:collective_param_resolver_local_test',
            '-//tensorflow/core/kernels/mkl:mkl_fused_ops_test',
            '-//tensorflow/core/kernels/mkl:mkl_fused_batch_norm_op_test',
            '-//tensorflow/core/ir/importexport/tests/roundtrip/...',
        ],
        'testopts': '--test_env=HOME=/tmp --test_timeout=3600 --test_size_filters=small ',
        'testopts_gpu': (
            '--test_env=HOME=/tmp --test_timeout=3600 --test_size_filters=small '
            '--run_under=//tensorflow/tools/ci_build/gpu_build:parallel_gpu_execute '
        ),
        'with_xla': True,
        'checksums': [
            {'v2.15.1.tar.gz': 'f36416d831f06fe866e149c7cd752da410a11178b01ff5620e9f265511ed57cf'},
            {'TensorFlow-2.13.0_add-missing-system-protobuf-targets.patch':
             '77d8c8a5627493fc7c38b4de79d49e60ff6628b05ff969f4cd3ff9857176c459'},
            {'TensorFlow-2.15.1_remove-libclang-dep.patch':
             '871b2f0221b7a150ac9f563ffad7187e052a7eedd95c20fb4524987d7edb6f21'},
            {'TensorFlow-2.15.1_remove-io-gcs-filesystem-dep.patch':
             'eba7351a4b0696c589b9c507bacb0257ebce8c39fde39ab72d5d6a69deaaec02'},
            {'TensorFlow-2.15.1_add-default-shell-env.patch':
             'dd22a1c1a014bfd62cb1fc8913b4705e0b9a45ba54803e0df57c74c17837d46e'},
            {'TensorFlow-2.15.1_fix-flatbuffer-license.patch':
             '2c04d5095977a628a238dbf93c5fada7159c86752a7183e64e0cf7c7ab00caf4'},
            {'TensorFlow-2.15.1_fix-pybind11-build.patch':
             '3bb350ac92ab99c63c951c96b3b0160699f5f16822b64f72111ebfd2275cafce'},
        ],
    }),
]


#  Taken from tensorboard-2.15.1-gfbf-2023a.eb:
#   Relax restriction on protobuf dependency as issue was fixed
#   in https://github.com/protocolbuffers/upb/pull/1514
#   see also: https://github.com/easybuilders/easybuild-easyconfigs/pull/19671
postinstallcmds = [
    'sed -i "s/Requires-Dist: protobuf.*/Requires-Dist: protobuf >=3.19.6/g" ' +
    '%(installdir)s/lib/python%(pyshortver)s/site-packages/tensorboard-2.15.2.dist-info/METADATA',
]

moduleclass = 'lib'
